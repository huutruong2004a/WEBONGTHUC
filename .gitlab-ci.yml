deploy_to_plesk_branch:
  stage: deploy_to_plesk_branch
  image: alpine:latest # Dùng alpine base
  before_script:
    - apk add --no-cache git # Cài git trong Alpine
  only:
    - develop
  script:
    - echo "Configuring Git for deployment..."
    - git config user.name "GitLab CI/CD Deployer"
    - git config user.email "gitlab-ci@example.com"
    - echo "Cloning and preparing deploy branch..."
    - git clone --depth 1 "https://gitlab-ci-token:${GITLAB_DEPLOY_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" deploy_temp_repo
    - cd deploy_temp_repo
    - git checkout -B plesk-deploy
    - echo "Cleaning existing files in deploy branch..."
    - find . -maxdepth 1 -not -name '.git' -not -name '.gitlab-ci.yml' -exec rm -rf {} +
    - echo "Copying published artifacts..."
    - cp -r ../$BUILD_OUTPUT_DIR/. .
    - echo "Adding changes and committing..."
    - git add .
    - git commit -m "CI/CD: Auto-deploying from $CI_COMMIT_SHORT_SHA" || true
    - echo "Pushing to plesk-deploy branch..."
    - git push -f "https://gitlab-ci-token:${GITLAB_DEPLOY_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" plesk-deploy
  dependencies:
    - build
