@model IEnumerable<WEB_CONG_THUC.Models.Blog>

@{
    ViewData["Title"] = "Danh sách Blog";
    int pageSize = 6; // Số bài blog trên mỗi trang
    int pageNumber = Convert.ToInt32(ViewBag.Page ?? 1); // Trang hiện tại, mặc định là 1
    var blogs = Model.Skip((pageNumber - 1) * pageSize).Take(pageSize); // Phân trang
}

<div class="container">
    <h2 class="text-center">Blog ẩm thực</h2>
    <p class="text-center text-muted">Khám phá các bài viết về ẩm thực, mẹo nấu ăn và văn hóa ẩm thực</p>

    <div class="row">
        <!-- Main content (70%) -->
        <div class="col-md-8">
            <!-- Danh sách blog -->
            @if (!blogs.Any())
            {
                <div class="alert alert-info text-center">
                    Không có thông tin "@ViewBag.SearchTerm" đang tìm
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var blog in blogs)
                    {
                        // Trích xuất câu đầu tiên từ Content (loại bỏ HTML và cắt ngắn)
                        string previewText = "";
                        if (!string.IsNullOrEmpty(blog.Content))
                        {
                            // Loại bỏ thẻ HTML để lấy văn bản thuần túy
                            string plainText = System.Text.RegularExpressions.Regex.Replace(blog.Content, "<[^>]+>", " ").Trim();
                            // Tìm câu đầu tiên bằng cách tìm dấu chấm đầu tiên
                            int firstPeriodIndex = plainText.IndexOf('.');
                            if (firstPeriodIndex != -1 && firstPeriodIndex < plainText.Length)
                            {
                                previewText = plainText.Substring(0, firstPeriodIndex + 1);
                            }
                            else
                            {
                                // Nếu không có dấu chấm, lấy tối đa 100 ký tự
                                previewText = plainText.Length > 100 ? plainText.Substring(0, 100) + "..." : plainText;
                            }
                        }

                        // Tính số ngày từ CreatedAt đến hiện tại
                        int daysAgo = (DateTime.Now - blog.CreatedAt).Days;

                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <a asp-action="Details" asp-route-slug="@blog.Slug">@blog.Title</a>
                                    </h5>
                                    <p class="card-text">
                                        @previewText
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-person"></i> Tác giả
                                        </div>
                                        <div>
                                            <i class="bi bi-clock"></i> @daysAgo ngày trước
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Phân trang -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        @{
                            int totalItems = Model.Count();
                            int totalPages = (int)Math.Ceiling((double)totalItems / pageSize);
                            for (int i = 1; i <= totalPages; i++)
                            {
                                <li class="page-item @(i == pageNumber ? "active" : "")">
                                    <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-searchTerm="@ViewBag.SearchTerm">@i</a>
                                </li>
                            }
                        }
                    </ul>
                </nav>
            }
        </div>

        <!-- Sidebar (30%) -->
        <div class="col-md-4">
            <!-- Phần tìm kiếm -->
            <div class="mb-4">
                <form asp-action="Index" method="get">
                    <div class="input-group">
                        <input type="text" class="form-control" name="searchTerm" placeholder="Tìm kiếm bài viết..." value="@ViewBag.SearchTerm" />
                        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                    </div>
                </form>
            </div>

            <!-- Top 3 bài được xem nhiều nhất -->
            <div>
                <h3>Top 3 bài được xem nhiều nhất</h3>
                <div class="list-group">
                    @foreach (var topBlog in ViewBag.TopViewedBlogs)
                    {
                        <a href="@Url.Action("Details", new { slug = topBlog.Slug })" class="list-group-item list-group-item-action">
                            @topBlog.Title <span class="badge badge-primary badge-pill">@topBlog.ViewCount lượt xem</span>
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<link href="~/css/index-blog.css" rel="stylesheet" />